<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<!--header-->
<header th:replace="~{fragments/header :: header}"></header>


<!--게시글 상세 정보-->
<h1> 게시글 상세 정보 </h1>
<div class="post-information">

    <!--게시글 정보-->
    <h1 th:text="${postInfo.title}">게시글 제목</h1>

    <!--로그인한 사용자에게만 보임-->
    <div sec:authorize="isAuthenticated()">
        <a th:href="@{/post/new}"> 게시글 작성 </a>

        <!--"작성자 == 로그인된 사용자" 일 경우 보임-->
        <a th:if="${postInfo.username} == ${#authentication.name}"
           th:href="@{'/post/' + ${postInfo.postId} + '/update'}"> 게시글 수정 </a>

        <!--"작성자 == 로그인된 사용자" 일 경우 보임-->
        <button th:if="${postInfo.username} == ${#authentication.name}"
                class="delete-post"
                th:data-id="${postInfo.postId}"
                onclick="deletePost(this.getAttribute('data-id'))">게시글 삭제</button>
    </div>


    <textarea th:text="${postInfo.content}" readonly style="width: 100%; height: 200px;">게시글 내용</textarea>


    <div>
        <label>작성자 : </label>
        <span th:text="${postInfo.member}">작성자</span>
    </div>
    <div>
        <label>조회수 : </label>
        <span th:text="${postInfo.view}">조회수</span>
    </div>
    <div>
        <label>작성일자 : </label>
        <span th:text="${postInfo.createdAt}">작성일자</span>
    </div>
    <div>
        <label>수정일자 : </label>
        <span th:text="${postInfo.updatedAt}">수정일자</span>
    </div>

</div>


<!--댓글 목록-->
<h1># 댓글 목록 #</h1>
<table>
    <thead>
    <tr>
        <th>#</th>
        <th>내용</th>
        <th>작성자</th>
        <th>수정</th>
        <th>삭제</th>
    </tr>
    </thead>
    <tbody>

    <tr th:each="comment : ${comments}">
        <td>#</td>
        <td>
            <span th:text="${comment.content}" th:id="'content-' + ${comment.id}">댓글내용</span>

            <!--댓글 수정을 위한 <textarea> / <button>-->
            <textarea th:id="'textarea-' + ${comment.id}" style="display:none;" required></textarea>
            <button th:id="'submit-' + ${comment.id}"
                    style="display:none;" type="button"
                    th:data-id="${comment.id}"
                    onclick="submitComment(this.getAttribute('data-id'))">게시</button>

        </td>
        <td th:text="${comment.nickname}">작성자</td>
        <td> <!--수정 버튼-->
            <button th:if="${comment.username} == ${#authentication.name}"
                    th:id="'update-' + ${comment.id}"
                    class="update-comment"
                    th:data-id="${comment.id}"
                    onclick="updateComment(this.getAttribute('data-id'))">수정</button>
        </td>
        <td> <!--삭제 버튼-->
            <button th:if="${comment.username} == ${#authentication.name}"
                    class="delete-comment"
                    th:data-id="${comment.id}"
                    onclick="deleteComment(this.getAttribute('data-id'))">삭제</button>
        </td>
    </tr>
    </tbody>
</table>


<!--댓글 작성 폼-->
<h1># 댓글 작성 #</h1>
<form th:action="@{'/post/' + ${postInfo.postId}}" th:object="${commentRequestDto}" method="post">

    <div>
        작성자 : <span sec:authentication="name">User</span>
    </div>
    <div>
        <label for="content">Content:</label>
        <textarea id="content" th:field="*{content}" required></textarea>
    </div>
    <div>
        <button type="submit">게시</button>
    </div>

</form>



<!--footer-->
<div th:replace="~{fragments/footer :: footer}"></div>



<script th:inline="javascript">

    /* 게시글 삭제 기능 수행 */
    function deletePost(postId) {
        fetch('/api/posts/' + postId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => {
            if (!response.ok) {
                throw new Error('네트워크 응답이 실패했습니다.');
            }
            return response.text(); // 응답을 텍스트로 처리
        }).then(message => {
            alert(message); // 서버로부터 받은 메시지를 직접 출력
            window.location.href = '/';
        }).catch(error => {
            console.error('게시글 삭제 중 오류 발생:', error);
            alert('게시글 삭제 중 오류 발생: ' + error.message); // 오류 메시지를 더 명확하게 표시
        });
    }


    /* 댓글 수정 모드 활성화 */
    function updateComment(commentId) {
        const contentSpan = document.getElementById(`content-${commentId}`);
        const textarea = document.getElementById(`textarea-${commentId}`);
        const submitButton = document.getElementById(`submit-${commentId}`);
        const updateButton = document.getElementById(`update-${commentId}`);

        textarea.value = contentSpan.innerText; //textarea <- 기존 content 넣기
        contentSpan.style.display = 'none'; //댓글 내용 숨김
        textarea.style.display = 'block'; //textarea 보이기
        submitButton.style.display = 'block'; //submitButton 보이기
        updateButton.style.display = 'none'; //updateButton 숨김
    }


    /* 댓글 수정 기능 수행 */
    function submitComment(commentId) {
        console.log("submitComment called with ID:", commentId);  // 로그 추가
        const textarea = document.getElementById(`textarea-${commentId}`);
        const newText = textarea.value; //수정된 내용 가져오기

        //요청 페이로드 준비
        const data = JSON.stringify({
            id: commentId,
            content: newText
        });

        fetch('/api/comments/' + commentId, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: data
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update comment');
                }
                if (response.headers.get('Content-Type').includes('application/json')) {
                    return response.json();
                } else {
                    throw new Error('Invalid response type');
                }
            })
            .then(data => {
                alert('댓글이 수정되었습니다: ' + data.message);
                const contentSpan = document.getElementById(`content-${commentId}`);
                contentSpan.innerText = newText;
                contentSpan.style.display = 'block';
                textarea.style.display = 'none';
                document.getElementById(`submit-${commentId}`).style.display = 'none'; // '게시' 버튼 숨기기
                document.getElementById(`update-${commentId}`).style.display = 'block'; // '수정' 버튼 보이기
            })
            .catch(error => {
                console.error('Error:', error);
                alert('댓글 수정 중 오류 발생: ' + error.message);
            });
    }



    /* 댓글 삭제 기능 수행 */
    function deleteComment(commentId) {
        fetch('/api/comments/' + commentId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => {
            if (!response.ok) {
                throw new Error('네트워크 응답이 실패했습니다.');
            }
            return response.text(); // 응답을 텍스트로 처리
        }).then(message => {
            alert(message); // 서버로부터 받은 메시지를 직접 출력
            location.reload(); //현재 페이지 새로고침
        }).catch(error => {
            console.error('댓글 삭제 중 오류 발생:', error);
            alert('댓글 삭제 중 오류 발생: ' + error.message); // 오류 메시지를 더 명확하게 표시
        });

    }

</script>

</body>
</html>